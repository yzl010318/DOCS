{"version":3,"file":"index.js","sources":["../../src/node/markdown/highlighter/createMarkdownFilePathGetter.ts","../../src/node/transformers/vuepressTransformers.ts","../../src/node/utils.ts","../../src/node/markdown/highlighter/createShikiHighlighter.ts","../../src/node/transformers/getTransformers.ts","../../src/node/markdown/highlighter/getLanguage.ts","../../src/node/markdown/highlighter/handleMustache.ts","../../src/node/markdown/highlighter/getHighLightFunction.ts","../../src/node/markdown/highlightLinesPlugin.ts","../../src/node/markdown/preWrapperPlugin.ts","../../src/node/prepareClientConfigFile.ts","../../src/node/shikiPlugin.ts"],"sourcesContent":["import type MarkdownIt from 'markdown-it'\nimport type { MarkdownEnv } from 'vuepress/markdown'\n\nexport type MarkdownFilePathGetter = () => string\n\nexport const createMarkdownFilePathGetter = (\n  md: MarkdownIt,\n): MarkdownFilePathGetter => {\n  const store: { path?: string | null } = {}\n\n  const rawRender = md.render.bind(md)\n\n  // we need to store file path before each render\n  md.render = (src, env: MarkdownEnv = {}) => {\n    store.path = env.filePathRelative\n\n    return rawRender(src, env)\n  }\n\n  return () => store.path || 'dynamic pages'\n}\n","import type { ShikiTransformer } from 'shiki'\n\nconst CODE_ESCAPE_RE = /\\[\\\\!code/g\n\nexport const addClassTransformer: ShikiTransformer = {\n  name: 'vuepress:add-class',\n  pre(node) {\n    this.addClassToHast(node, 'vp-code')\n  },\n}\n\nexport const cleanupTransformer: ShikiTransformer = {\n  name: 'vuepress:cleanup',\n  pre(node) {\n    delete node.properties.tabindex\n  },\n}\n\n/**\n * This `transformer` is primarily for the usage instructions of themes.\n * When developers need to provide an example like `// [!code xxx]`,\n * they can use `// [\\!code xxx]` to avoid being processed by `shiki`.\n * After `shiki` completes the processing,\n * replace `[\\!code` back with `[!code` to display the correct text.\n */\nexport const removeEscapeTransformer: ShikiTransformer = {\n  name: 'vuepress:remove-escape',\n  postprocess(code) {\n    return code.replace(CODE_ESCAPE_RE, '[!code')\n  },\n}\n\nexport const emptyLineTransformer: ShikiTransformer = {\n  name: 'vuepress:empty-line',\n  code(hast) {\n    hast.children.forEach((span) => {\n      if (\n        span.type === 'element' &&\n        span.tagName === 'span' &&\n        Array.isArray(span.properties.class) &&\n        span.properties.class.includes('line') &&\n        span.children.length === 0\n      ) {\n        span.children.push({\n          type: 'element',\n          tagName: 'wbr',\n          properties: {},\n          children: [],\n        })\n      }\n    })\n  },\n}\n\nexport const vPreTransformer: ShikiTransformer = {\n  name: 'vuepress:v-pre',\n  pre(node) {\n    node.properties['v-pre'] = ''\n  },\n}\n","import type { TransformerCompactLineOption } from '@shikijs/transformers'\nimport { Logger } from '@vuepress/helper'\nimport { customAlphabet } from 'nanoid'\n\nconst VUE_RE = /-vue$/\n\nexport const TWOSLASH_RE = /\\btwoslash\\b/\n\nexport const PLUGIN_NAME = '@vuepress/plugin-shiki'\n\nexport const logger = new Logger(PLUGIN_NAME)\n\nexport const nanoid = customAlphabet('abcdefghijklmnopqrstuvwxyz', 10)\n\nexport const resolveLanguage = (info: string): string =>\n  info\n    .match(/^([^ :[{]+)/)?.[1]\n    ?.replace(VUE_RE, '')\n    .toLowerCase() ?? ''\n\n/**\n * 2 steps:\n *\n * 1. convert attrs into line numbers:\n *    {4,7-13,16,23-27,40} -> [4,7,8,9,10,11,12,13,16,23,24,25,26,27,40]\n * 2. convert line numbers into line options:\n *    [{ line: number, classes: string[] }]\n */\nexport const attrsToLines = (attrs: string): TransformerCompactLineOption[] => {\n  const attrsContent = attrs.replace(/^(?:\\[.*?\\])?.*?([\\d,-]+).*/, '$1').trim()\n\n  const result: number[] = []\n\n  if (!attrsContent) {\n    return []\n  }\n\n  attrsContent\n    .split(',')\n    .map((lineNumberConfig) =>\n      lineNumberConfig.split('-').map((lineNumber) => parseInt(lineNumber, 10)),\n    )\n    .forEach(([start, end]) => {\n      if (start && end) {\n        result.push(\n          ...Array.from({ length: end - start + 1 }, (_, i) => start + i),\n        )\n      } else {\n        result.push(start)\n      }\n    })\n\n  return result.map((line) => ({\n    line,\n    classes: ['highlighted'],\n  }))\n}\n","import { createRequire } from 'node:module'\nimport type {\n  BundledLanguage,\n  BundledTheme,\n  HighlighterGeneric,\n  ShikiTransformer,\n} from 'shiki'\nimport { createHighlighter, isSpecialLang } from 'shiki'\nimport { createSyncFn } from 'synckit'\nimport type { App } from 'vuepress'\nimport { isPlainObject } from 'vuepress/shared'\nimport type { ShikiPluginOptions } from '../../options.js'\nimport type { ShikiResolveLang } from '../../resolveLang.js'\nimport { vPreTransformer } from '../../transformers/vuepressTransformers.js'\nimport { resolveLanguage } from '../../utils.js'\n\nconst require = createRequire(import.meta.url)\n\nconst resolveLangSync = createSyncFn<ShikiResolveLang>(\n  require.resolve('@vuepress/plugin-shiki/resolveLang'),\n)\n\nexport type ShikiLoadLang = (lang: string) => boolean\n\nexport const createShikiHighlighter = async (\n  app: App,\n  {\n    langs = [],\n    langAlias = {},\n    defaultLang,\n    shikiSetup,\n    ...options\n  }: ShikiPluginOptions = {},\n  enableVPre = true,\n): Promise<{\n  highlighter: HighlighterGeneric<BundledLanguage, BundledTheme>\n  loadLang: ShikiLoadLang\n  extraTransformers: ShikiTransformer[]\n}> => {\n  const highlighter = await createHighlighter({\n    langs: [...langs, ...Object.values(langAlias)],\n    langAlias,\n    themes:\n      'themes' in options\n        ? Object.values(options.themes)\n        : [options.theme ?? 'nord'],\n  })\n\n  const loadLang = (lang: string): boolean => {\n    if (isSpecialLang(lang)) return true\n\n    const loadedLangs = highlighter.getLoadedLanguages()\n\n    if (!loadedLangs.includes(lang)) {\n      const resolvedLang = resolveLangSync(lang)\n\n      if (!resolvedLang.length) return false\n\n      highlighter.loadLanguageSync(resolvedLang)\n    }\n\n    return true\n  }\n\n  // patch for twoslash - https://github.com/vuejs/vitepress/issues/4334\n  const rawGetLanguage = highlighter.getLanguage\n\n  highlighter.getLanguage = (name) => {\n    const lang = typeof name === 'string' ? name : name.name\n\n    loadLang(resolveLanguage(lang))\n\n    return rawGetLanguage.call(highlighter, name)\n  }\n\n  const extraTransformers: ShikiTransformer[] = []\n\n  if (enableVPre) extraTransformers.push(vPreTransformer)\n\n  if (options.twoslash) {\n    const { createTwoslashTransformer, createFileSystemTypesCache } =\n      await import('@vuepress/shiki-twoslash')\n\n    const { typesCache, ...twoslashOptions } = isPlainObject(options.twoslash)\n      ? options.twoslash\n      : {}\n    extraTransformers.push(\n      await createTwoslashTransformer({\n        ...twoslashOptions,\n        typesCache:\n          typesCache === true || typeof typesCache === 'undefined'\n            ? createFileSystemTypesCache({\n                dir: app.dir.cache('markdown/twoslash'),\n              })\n            : typesCache,\n      }),\n    )\n  }\n\n  await shikiSetup?.(highlighter)\n\n  return { highlighter, loadLang, extraTransformers }\n}\n","import {\n  transformerMetaWordHighlight,\n  transformerNotationDiff,\n  transformerNotationErrorLevel,\n  transformerNotationFocus,\n  transformerNotationHighlight,\n  transformerNotationWordHighlight,\n  transformerRenderWhitespace,\n} from '@shikijs/transformers'\nimport type { WhitespacePosition } from '@vuepress/highlighter-helper'\nimport { resolveWhitespacePosition } from '@vuepress/highlighter-helper'\nimport type { ShikiTransformer } from 'shiki'\nimport type { ShikiHighlightOptions } from '../types.js'\nimport {\n  addClassTransformer,\n  cleanupTransformer,\n  emptyLineTransformer,\n  removeEscapeTransformer,\n} from './vuepressTransformers.js'\n\nexport const getTransformers = (\n  options: ShikiHighlightOptions & {\n    twoslash?: boolean\n  },\n): ShikiTransformer[] => {\n  const transformers: ShikiTransformer[] = []\n\n  if (options.notationDiff) {\n    transformers.push(transformerNotationDiff())\n  }\n\n  if (options.notationFocus) {\n    transformers.push(\n      transformerNotationFocus({\n        classActiveLine: 'has-focus',\n        classActivePre: 'has-focused-lines',\n      }),\n    )\n  }\n\n  if (options.notationHighlight) {\n    transformers.push(transformerNotationHighlight())\n  }\n\n  if (options.notationErrorLevel) {\n    transformers.push(transformerNotationErrorLevel())\n  }\n\n  if (options.notationWordHighlight) {\n    transformers.push(transformerNotationWordHighlight())\n    transformers.push(transformerMetaWordHighlight())\n  }\n\n  transformers.push(\n    addClassTransformer,\n    cleanupTransformer,\n    removeEscapeTransformer,\n    emptyLineTransformer,\n  )\n\n  return transformers\n}\n\nexport const whitespaceTransformer = (\n  meta: string,\n  defaultPosition: WhitespacePosition | boolean = false,\n): ShikiTransformer[] => {\n  const position = resolveWhitespacePosition(meta, defaultPosition)\n  // disable current code block\n  if (position === false) return []\n\n  return [transformerRenderWhitespace({ position })]\n}\n","import { colors } from 'vuepress/utils'\nimport type { ShikiHighlightOptions } from '../../types.js'\nimport { logger, resolveLanguage } from '../../utils.js'\nimport type { MarkdownFilePathGetter } from './createMarkdownFilePathGetter.js'\nimport type { ShikiLoadLang } from './createShikiHighlighter.js'\n\nconst WARNED_LANGS = new Set<string>()\n\nexport const getLanguage = (\n  lang: string,\n  { defaultLang, logLevel }: ShikiHighlightOptions,\n  loadLang: ShikiLoadLang,\n  markdownFilePathGetter: MarkdownFilePathGetter,\n): string => {\n  let result = resolveLanguage(lang)\n\n  if (result && !loadLang(result)) {\n    // warn for unknown languages only once\n    if (logLevel !== 'silent' && !WARNED_LANGS.has(result)) {\n      logger.warn(\n        `Missing ${colors.cyan(lang)} highlighter, ${defaultLang ? `use ${colors.cyan(defaultLang)} to highlight instead.` : 'skip highlighting'}`,\n      )\n      WARNED_LANGS.add(result)\n    }\n\n    // log file path if unknown language is found\n    if (logLevel === 'debug') {\n      logger.info(\n        `Unknown language ${colors.cyan(result)} found in ${colors.cyan(markdownFilePathGetter())}`,\n      )\n    }\n\n    result = defaultLang || 'plain'\n  }\n\n  return result\n}\n","import { nanoid } from '../../utils.js'\n\nconst MUSTACHE_REG = /\\{\\{[^]*?\\}\\}/g\n\ntype MustacheStore = Map<string, string>\n\n/**\n * Replace mustache with unique markers\n * @param str content\n * @param store mustache store\n * @returns\n */\nconst removeMustache = (str: string, store: MustacheStore): string =>\n  str.replace(MUSTACHE_REG, (match) => {\n    let marker = store.get(match)\n\n    if (!marker) {\n      marker = nanoid()\n      store.set(match, marker)\n    }\n\n    return marker\n  })\n\nconst restoreMustache = (str: string, store: MustacheStore): string => {\n  let result = str\n\n  store.forEach((marker, match) => {\n    result = result.replaceAll(marker, match)\n  })\n\n  return result\n}\n\nexport const handleMustache = (\n  str: string,\n  highlight: (str: string) => string,\n): string => {\n  const store = new Map<string, string>()\n\n  return restoreMustache(highlight(removeMustache(str, store).trimEnd()), store)\n}\n","import { transformerCompactLineOptions } from '@shikijs/transformers'\nimport type {\n  BundledLanguage,\n  BundledTheme,\n  HighlighterGeneric,\n  ShikiTransformer,\n} from 'shiki'\nimport {\n  getTransformers,\n  whitespaceTransformer,\n} from '../../transformers/getTransformers.js'\nimport type { ShikiHighlightOptions } from '../../types.js'\nimport { attrsToLines } from '../../utils.js'\nimport type { MarkdownFilePathGetter } from './createMarkdownFilePathGetter.js'\nimport type { ShikiLoadLang } from './createShikiHighlighter.js'\nimport { getLanguage } from './getLanguage.js'\nimport { handleMustache } from './handleMustache.js'\n\ntype MarkdownItHighlight = (\n  content: string,\n  language: string,\n  attrs: string,\n) => string\n\nexport const getHighLightFunction = (\n  highlighter: HighlighterGeneric<BundledLanguage, BundledTheme>,\n  options: ShikiHighlightOptions,\n  extraTransformers: ShikiTransformer[] | undefined,\n  loadLang: ShikiLoadLang,\n  markdownFilePathGetter: MarkdownFilePathGetter,\n): MarkdownItHighlight => {\n  const transformers = getTransformers(options)\n\n  return (content, language, attrs) =>\n    handleMustache(content, (str) =>\n      highlighter.codeToHtml(str, {\n        lang: getLanguage(language, options, loadLang, markdownFilePathGetter),\n        meta: {\n          /**\n           * Custom `transformers` passed by users may require `attrs`.\n           * e.g. [transformerNotationWordHighlight](https://shiki.style/packages/transformers#transformernotationwordhighlight)\n           */\n          __raw: attrs,\n        },\n        transformers: [\n          ...transformers,\n          ...((options.highlightLines ?? true)\n            ? [transformerCompactLineOptions(attrsToLines(attrs))]\n            : []),\n          ...whitespaceTransformer(attrs, options.whitespace),\n          ...(extraTransformers ?? []),\n          ...(options.transformers ?? []),\n        ],\n        ...('themes' in options\n          ? {\n              themes: options.themes,\n              defaultColor: false,\n            }\n          : { theme: options.theme ?? 'nord' }),\n      }),\n    )\n}\n","// Modified from https://github.com/egoist/markdown-it-highlight-lines\n// Now this plugin is only used to normalize line attrs.\n// The else part of line highlights logic is in '../highlight.ts'.\n\nimport type { Markdown } from 'vuepress/markdown'\n\nconst HIGHLIGHT_LINES_REGEXP = /{([\\d,-]+)}/\n\nexport const highlightLinesPlugin = (md: Markdown): void => {\n  const rawFence = md.renderer.rules.fence!\n\n  md.renderer.rules.fence = (...args) => {\n    const [tokens, idx] = args\n    const token = tokens[idx]\n\n    const rawInfo = token.info || ''\n    const result = rawInfo.match(HIGHLIGHT_LINES_REGEXP)\n\n    if (!result) {\n      return rawFence(...args)\n    }\n\n    // ensure the next plugin get the correct lang\n    token.info = rawInfo.replace(HIGHLIGHT_LINES_REGEXP, '').trim()\n\n    const lines = result[1]\n\n    token.info += ` ${lines}`\n    return rawFence(...args)\n  }\n}\n","// markdown-it plugin for generating line numbers.\n// v-pre block logic is in `../highlight.ts`\nimport type { Markdown } from 'vuepress/markdown'\nimport { resolveLanguage } from '../utils.js'\n\nconst PRE_ATTRS_REGEXP = /<pre([\\s\\S]*?)style=\"([^\"]*)\"([^>]*)>/\n\nexport interface MarkdownItPreWrapperOptions {\n  /**\n   * Wrap the `<pre>` tag with an extra `<div>` or not. Do not disable it unless you\n   * understand what's it for\n   *\n   * - Required for line numbers, title display and code block collapsing\n   */\n  preWrapper?: boolean\n}\n\nexport const preWrapperPlugin = (\n  md: Markdown,\n  { preWrapper = true }: MarkdownItPreWrapperOptions = {},\n): void => {\n  const rawFence = md.renderer.rules.fence!\n\n  md.renderer.rules.fence = (...args) => {\n    let result = rawFence(...args)\n\n    if (!result.startsWith('<pre')) {\n      return result\n    }\n\n    const [tokens, idx, options] = args\n    const token = tokens[idx]\n\n    // get token info\n    const info = token.info ? md.utils.unescapeAll(token.info).trim() : ''\n\n    const lang = resolveLanguage(info)\n    const languageClass = `${options.langPrefix}${lang}`\n\n    if (!preWrapper) {\n      /**\n       * remove `<code>` attributes\n       *\n       * In the source code of `markdown-it fence line 71, line 74`,\n       * `fence` writes `class=\"language-*\"` onto the `code` element,\n       * whereas in past versions, `vuepress` wrote it on the `pre` element.\n       * Therefore, this behavior needs to be reset.\n       *\n       * Even though `shiki` directly returns the contents within `<pre>`\n       * at `line 48` of `markdown-it`, I believe it is still prudent to make this adjustment.\n       *\n       * @see https://github.com/markdown-it/markdown-it/blob/master/lib/renderer.mjs\n       */\n      result = result.replace(/<code[^]*?>/, '<code>')\n      result = `<pre class=\"${languageClass}\"${result.slice('<pre'.length)}`\n      return result\n    }\n    let styles = ''\n\n    // before: maybe `v-pre class=\"shiki *\"`\n    // after: style=\"*\" tab-index=\"*\"\n    result = result.replace(\n      PRE_ATTRS_REGEXP,\n      (_, before: string, style: string, after: string) => {\n        styles = style.trim()\n        // Keep `v-pre class=\"*\"`, remove the rest.\n        return `<pre ${before.trim()}${after.trimEnd()}>`\n      },\n    )\n\n    /**\n     * Add information to dataset for current code block.\n     */\n    return `<div class=\"${languageClass}\" data-highlighter=\"shiki\" data-ext=\"${lang}\" style=\"${styles}\">${result}</div>`\n  }\n}\n","import { getModulePath } from '@vuepress/helper'\nimport type { App } from 'vuepress'\nimport type { ShikiPluginOptions } from './options.js'\nimport { PLUGIN_NAME } from './utils.js'\n\nexport const prepareClientConfigFile = (\n  app: App,\n  {\n    lineNumbers = true,\n    highlightLines = true,\n    collapsedLines = 'disable',\n    codeBlockTitle = true,\n    notationDiff,\n    notationErrorLevel,\n    notationFocus,\n    notationHighlight,\n    notationWordHighlight,\n    whitespace,\n    twoslash,\n  }: ShikiPluginOptions,\n): Promise<string> => {\n  const imports: string[] = [\n    `import \"${getModulePath('@vuepress/highlighter-helper/styles/base.css', import.meta)}\"`,\n    `import \"${getModulePath(`${PLUGIN_NAME}/styles/shiki.css`, import.meta)}\"`,\n  ]\n\n  const enhances: string[] = []\n  const setups: string[] = []\n\n  if (lineNumbers !== 'disable') {\n    imports.push(\n      `import \"${getModulePath('@vuepress/highlighter-helper/styles/line-numbers.css', import.meta)}\"`,\n    )\n  }\n\n  if (highlightLines || notationHighlight) {\n    imports.push(\n      `import \"${getModulePath('@vuepress/highlighter-helper/styles/notation-highlight.css', import.meta)}\"`,\n    )\n  }\n\n  if (notationDiff) {\n    imports.push(\n      `import \"${getModulePath('@vuepress/highlighter-helper/styles/notation-diff.css', import.meta)}\"`,\n    )\n  }\n\n  if (notationErrorLevel) {\n    imports.push(\n      `import \"${getModulePath('@vuepress/highlighter-helper/styles/notation-error-level.css', import.meta)}\"`,\n    )\n  }\n\n  if (notationFocus) {\n    imports.push(\n      `import \"${getModulePath('@vuepress/highlighter-helper/styles/notation-focus.css', import.meta)}\"`,\n    )\n  }\n\n  if (notationHighlight) {\n    imports.push(\n      `import \"${getModulePath('@vuepress/highlighter-helper/styles/notation-highlight.css', import.meta)}\"`,\n    )\n  }\n\n  if (notationWordHighlight) {\n    imports.push(\n      `import \"${getModulePath('@vuepress/highlighter-helper/styles/notation-word-highlight.css', import.meta)}\"`,\n    )\n  }\n\n  if (whitespace) {\n    imports.push(\n      `import \"${getModulePath('@vuepress/highlighter-helper/styles/whitespace.css', import.meta)}\"`,\n    )\n  }\n\n  if (collapsedLines !== 'disable') {\n    imports.push(\n      `import \"${getModulePath('@vuepress/highlighter-helper/styles/collapsed-lines.css', import.meta)}\"`,\n      `import { setupCollapsedLines } from \"${getModulePath('@vuepress/highlighter-helper/client', import.meta)}\"`,\n    )\n    setups.push('setupCollapsedLines()')\n  }\n\n  if (codeBlockTitle) {\n    imports.push(\n      `import \"${getModulePath('@vuepress/highlighter-helper/styles/code-block-title.css', import.meta)}\"`,\n    )\n  }\n\n  if (twoslash) {\n    imports.push(\n      `import { enhanceTwoslash } from \"${getModulePath('@vuepress/shiki-twoslash/client', import.meta)}\"`,\n    )\n    imports.push(\n      `import \"${getModulePath('@vuepress/shiki-twoslash/styles/twoslash.css', import.meta)}\"`,\n    )\n    enhances.push('enhanceTwoslash(app)')\n  }\n\n  let code = imports.join('\\n')\n\n  if (setups.length || enhances.length) {\n    code += `\nexport default {\n`\n\n    if (enhances.length) {\n      code += `\\\n  enhance({ app }) {\n    ${enhances.join('\\n    ')}\n  },\n`\n    }\n\n    if (setups.length) {\n      code += `\\\n  setup() {\n    ${setups.join('\\n    ')}\n  },\n`\n    }\n\n    code += `\\\n}\n`\n  }\n\n  return app.writeTemp('shiki/config.js', code)\n}\n","import { isModuleAvailable } from '@vuepress/helper'\nimport type {\n  MarkdownItCodeBlockTitleOptions,\n  MarkdownItCollapsedLinesOptions,\n  MarkdownItLineNumbersOptions,\n} from '@vuepress/highlighter-helper'\nimport {\n  codeBlockTitle as codeBlockTitlePlugin,\n  collapsedLines as collapsedLinesPlugin,\n  lineNumbers as lineNumbersPlugin,\n} from '@vuepress/highlighter-helper'\nimport type { Plugin } from 'vuepress/core'\nimport { isPlainObject } from 'vuepress/shared'\nimport { colors } from 'vuepress/utils'\nimport { createMarkdownFilePathGetter } from './markdown/highlighter/createMarkdownFilePathGetter.js'\nimport type { MarkdownItPreWrapperOptions } from './markdown/index.js'\nimport {\n  createShikiHighlighter,\n  getHighLightFunction,\n  highlightLinesPlugin,\n  preWrapperPlugin,\n} from './markdown/index.js'\nimport type { ShikiPluginOptions } from './options.js'\nimport { prepareClientConfigFile } from './prepareClientConfigFile.js'\nimport { TWOSLASH_RE, logger } from './utils.js'\n\nexport const shikiPlugin = (_options: ShikiPluginOptions = {}): Plugin => {\n  return (app) => {\n    // FIXME: Remove in stable version\n    // eslint-disable-next-line @typescript-eslint/no-deprecated\n    const { code } = app.options.markdown\n    const options = {\n      ...(isPlainObject(code) ? code : {}),\n      ..._options,\n    }\n\n    options.logLevel ??= app.env.isDebug ? 'debug' : 'warn'\n    options.preWrapper ??= true\n    options.lineNumbers ??= true\n    options.collapsedLines ??= 'disable'\n    options.codeBlockTitle ??= true\n\n    if (\n      options.twoslash &&\n      !isModuleAvailable('@vuepress/shiki-twoslash', import.meta)\n    ) {\n      logger.error(\n        `${colors.cyan('twoslash')} is enabled, but ${colors.magenta('@vuepress/shiki-twoslash')} is not installed, please install it manually`,\n      )\n      options.twoslash = false\n    }\n\n    /**\n     * Whether to enable the `v-pre` configuration of the code block\n     */\n    let enableVPre = true\n\n    return {\n      name: '@vuepress/plugin-shiki',\n\n      extendsMarkdownOptions: (opts) => {\n        /**\n         * Turn off the `v-pre` configuration of the code block.\n         */\n        if (opts.vPre !== false) {\n          const vPre = isPlainObject(opts.vPre) ? opts.vPre : { block: true }\n          if (vPre.block) {\n            opts.vPre ??= {}\n            opts.vPre.block = false\n          }\n          enableVPre = vPre.block ?? true\n        } else {\n          enableVPre = false\n        }\n      },\n\n      extendsMarkdown: async (md) => {\n        const { preWrapper, lineNumbers, collapsedLines, codeBlockTitle } =\n          options\n\n        const markdownFilePathGetter = createMarkdownFilePathGetter(md)\n        const { highlighter, loadLang, extraTransformers } =\n          await createShikiHighlighter(app, options, enableVPre)\n\n        md.options.highlight = getHighLightFunction(\n          highlighter,\n          options,\n          extraTransformers,\n          loadLang,\n          markdownFilePathGetter,\n        )\n\n        md.use(highlightLinesPlugin)\n        md.use<MarkdownItPreWrapperOptions>(preWrapperPlugin, { preWrapper })\n        if (preWrapper) {\n          md.use<MarkdownItLineNumbersOptions>(lineNumbersPlugin, {\n            lineNumbers,\n            resolveLineNumbers(info) {\n              return options.twoslash && TWOSLASH_RE.test(info)\n                ? false\n                : undefined\n            },\n          })\n          md.use<MarkdownItCollapsedLinesOptions>(collapsedLinesPlugin, {\n            collapsedLines,\n          })\n          md.use<MarkdownItCodeBlockTitleOptions>(codeBlockTitlePlugin, {\n            codeBlockTitle,\n          })\n        }\n      },\n\n      clientConfigFile: () => prepareClientConfigFile(app, options),\n    }\n  }\n}\n"],"names":["createMarkdownFilePathGetter","md","store","rawRender","src","env","CODE_ESCAPE_RE","addClassTransformer","node","cleanupTransformer","removeEscapeTransformer","code","emptyLineTransformer","hast","span","vPreTransformer","VUE_RE","TWOSLASH_RE","PLUGIN_NAME","logger","Logger","nanoid","customAlphabet","resolveLanguage","info","attrsToLines","attrs","attrsContent","result","lineNumberConfig","lineNumber","start","end","_","i","line","require","createRequire","resolveLangSync","createSyncFn","createShikiHighlighter","app","langs","langAlias","defaultLang","shikiSetup","options","enableVPre","highlighter","createHighlighter","loadLang","lang","isSpecialLang","resolvedLang","rawGetLanguage","name","extraTransformers","createTwoslashTransformer","createFileSystemTypesCache","typesCache","twoslashOptions","isPlainObject","getTransformers","transformers","transformerNotationDiff","transformerNotationFocus","transformerNotationHighlight","transformerNotationErrorLevel","transformerNotationWordHighlight","transformerMetaWordHighlight","whitespaceTransformer","meta","defaultPosition","position","resolveWhitespacePosition","transformerRenderWhitespace","WARNED_LANGS","getLanguage","logLevel","markdownFilePathGetter","colors","MUSTACHE_REG","removeMustache","str","match","marker","restoreMustache","handleMustache","highlight","getHighLightFunction","content","language","transformerCompactLineOptions","HIGHLIGHT_LINES_REGEXP","highlightLinesPlugin","rawFence","args","tokens","idx","token","rawInfo","lines","PRE_ATTRS_REGEXP","preWrapperPlugin","preWrapper","languageClass","styles","before","style","after","prepareClientConfigFile","lineNumbers","highlightLines","collapsedLines","codeBlockTitle","notationDiff","notationErrorLevel","notationFocus","notationHighlight","notationWordHighlight","whitespace","twoslash","imports","getModulePath","enhances","setups","shikiPlugin","_options","isModuleAvailable","opts","vPre","lineNumbersPlugin","collapsedLinesPlugin","codeBlockTitlePlugin"],"mappings":"qxBAKO,MAAMA,EACXC,GAC2B,CAC3B,MAAMC,EAAkC,CAAC,EAEnCC,EAAYF,EAAG,OAAO,KAAKA,CAAE,EAGnC,OAAAA,EAAG,OAAS,CAACG,EAAKC,EAAmB,CAAA,KACnCH,EAAM,KAAOG,EAAI,iBAEVF,EAAUC,EAAKC,CAAG,GAGpB,IAAMH,EAAM,MAAQ,eAC7B,EClBMI,EAAiB,aAEVC,EAAwC,CACnD,KAAM,qBACN,IAAIC,EAAM,CACR,KAAK,eAAeA,EAAM,SAAS,CACrC,CACF,EAEaC,EAAuC,CAClD,KAAM,mBACN,IAAID,EAAM,CACR,OAAOA,EAAK,WAAW,QACzB,CACF,EASaE,EAA4C,CACvD,KAAM,yBACN,YAAYC,EAAM,CAChB,OAAOA,EAAK,QAAQL,EAAgB,QAAQ,CAC9C,CACF,EAEaM,EAAyC,CACpD,KAAM,sBACN,KAAKC,EAAM,CACTA,EAAK,SAAS,QAASC,GAAS,CAE5BA,EAAK,OAAS,WACdA,EAAK,UAAY,QACjB,MAAM,QAAQA,EAAK,WAAW,KAAK,GACnCA,EAAK,WAAW,MAAM,SAAS,MAAM,GACrCA,EAAK,SAAS,SAAW,GAEzBA,EAAK,SAAS,KAAK,CACjB,KAAM,UACN,QAAS,MACT,WAAY,CACZ,EAAA,SAAU,CAAA,CACZ,CAAC,CAEL,CAAC,CACH,CACF,EAEaC,EAAoC,CAC/C,KAAM,iBACN,IAAIP,EAAM,CACRA,EAAK,WAAW,OAAO,EAAI,EAC7B,CACF,ECvDMQ,EAAS,QAEFC,EAAc,eAEdC,EAAc,yBAEdC,EAAS,IAAIC,EAAOF,CAAW,EAE/BG,EAASC,EAAe,6BAA8B,EAAE,EAExDC,EAAmBC,GAC9BA,EACG,MAAM,aAAa,IAAI,CAAC,GACvB,QAAQR,EAAQ,EAAE,EACnB,eAAiB,GAUTS,GAAgBC,GAAkD,CAC7E,MAAMC,EAAeD,EAAM,QAAQ,8BAA+B,IAAI,EAAE,KAAK,EAEvEE,EAAmB,CAAA,EAEzB,OAAKD,GAILA,EACG,MAAM,GAAG,EACT,IAAKE,GACJA,EAAiB,MAAM,GAAG,EAAE,IAAKC,GAAe,SAASA,EAAY,EAAE,CAAC,CAC1E,EACC,QAAQ,CAAC,CAACC,EAAOC,CAAG,IAAM,CACrBD,GAASC,EACXJ,EAAO,KACL,GAAG,MAAM,KAAK,CAAE,OAAQI,EAAMD,EAAQ,CAAE,EAAG,CAACE,EAAGC,IAAMH,EAAQG,CAAC,CAChE,EAEAN,EAAO,KAAKG,CAAK,CAErB,CAAC,EAEIH,EAAO,IAAKO,IAAU,CAC3B,KAAAA,EACA,QAAS,CAAC,aAAa,CACzB,EAAE,GArBO,EAsBX,ECxCMC,GAAUC,EAAc,YAAY,GAAG,EAEvCC,GAAkBC,EACtBH,GAAQ,QAAQ,oCAAoC,CACtD,EAIaI,GAAyB,MACpCC,EACA,CACE,MAAAC,EAAQ,GACR,UAAAC,EAAY,CACZ,EAAA,YAAAC,EACA,WAAAC,EACA,GAAGC,CACL,EAAwB,CAAA,EACxBC,EAAa,KAKT,CACJ,MAAMC,EAAc,MAAMC,EAAkB,CAC1C,MAAO,CAAC,GAAGP,EAAO,GAAG,OAAO,OAAOC,CAAS,CAAC,EAC7C,UAAAA,EACA,OACE,WAAYG,EACR,OAAO,OAAOA,EAAQ,MAAM,EAC5B,CAACA,EAAQ,OAAS,MAAM,CAChC,CAAC,EAEKI,EAAYC,GAA0B,CAC1C,GAAIC,EAAcD,CAAI,EAAG,SAIzB,GAAI,CAFgBH,EAAY,qBAEf,SAASG,CAAI,EAAG,CAC/B,MAAME,EAAef,GAAgBa,CAAI,EAEzC,GAAI,CAACE,EAAa,OAAQ,MAE1BL,GAAAA,EAAY,iBAAiBK,CAAY,CAC3C,CAEA,QACF,EAGMC,EAAiBN,EAAY,YAEnCA,EAAY,YAAeO,GAAS,CAClC,MAAMJ,EAAO,OAAOI,GAAS,SAAWA,EAAOA,EAAK,KAEpD,OAAAL,EAAS3B,EAAgB4B,CAAI,CAAC,EAEvBG,EAAe,KAAKN,EAAaO,CAAI,CAC9C,EAEA,MAAMC,EAAwC,GAI9C,GAFIT,GAAYS,EAAkB,KAAKzC,CAAe,EAElD+B,EAAQ,SAAU,CACpB,KAAM,CAAE,0BAAAW,EAA2B,2BAAAC,CAA2B,EAC5D,KAAM,QAAO,0BAA0B,EAEnC,CAAE,WAAAC,EAAY,GAAGC,CAAgB,EAAIC,EAAcf,EAAQ,QAAQ,EACrEA,EAAQ,SACR,GACJU,EAAkB,KAChB,MAAMC,EAA0B,CAC9B,GAAGG,EACH,WACED,IAAe,IAAQ,OAAOA,EAAe,IACzCD,EAA2B,CACzB,IAAKjB,EAAI,IAAI,MAAM,mBAAmB,CACxC,CAAC,EACDkB,CACR,CAAC,CACH,CACF,CAEA,OAAA,MAAMd,IAAaG,CAAW,EAEvB,CAAE,YAAAA,EAAa,SAAAE,EAAU,kBAAAM,CAAkB,CACpD,EClFaM,GACXhB,GAGuB,CACvB,MAAMiB,EAAmC,CAAA,EAEzC,OAAIjB,EAAQ,cACViB,EAAa,KAAKC,EAAyB,CAAA,EAGzClB,EAAQ,eACViB,EAAa,KACXE,EAAyB,CACvB,gBAAiB,YACjB,eAAgB,mBAClB,CAAC,CACH,EAGEnB,EAAQ,mBACViB,EAAa,KAAKG,EAA8B,CAAA,EAG9CpB,EAAQ,oBACViB,EAAa,KAAKI,EAA+B,CAAA,EAG/CrB,EAAQ,wBACViB,EAAa,KAAKK,EAAkC,CAAA,EACpDL,EAAa,KAAKM,GAA8B,GAGlDN,EAAa,KACXxD,EACAE,EACAC,EACAE,CACF,EAEOmD,CACT,EAEaO,GAAwB,CACnCC,EACAC,EAAgD,KACzB,CACvB,MAAMC,EAAWC,EAA0BH,EAAMC,CAAe,EAEhE,OAAIC,IAAa,GAAc,CAAA,EAExB,CAACE,EAA4B,CAAE,SAAAF,CAAS,CAAC,CAAC,CACnD,EClEMG,EAAe,IAAI,IAEZC,GAAc,CACzB1B,EACA,CAAE,YAAAP,EAAa,SAAAkC,CAAS,EACxB5B,EACA6B,IACW,CACX,IAAInD,EAASL,EAAgB4B,CAAI,EAEjC,OAAIvB,GAAU,CAACsB,EAAStB,CAAM,IAExBkD,IAAa,UAAY,CAACF,EAAa,IAAIhD,CAAM,IACnDT,EAAO,KACL,WAAW6D,EAAO,KAAK7B,CAAI,CAAC,iBAAiBP,EAAc,OAAOoC,EAAO,KAAKpC,CAAW,CAAC,yBAA2B,mBAAmB,EAC1I,EACAgC,EAAa,IAAIhD,CAAM,GAIrBkD,IAAa,SACf3D,EAAO,KACL,oBAAoB6D,EAAO,KAAKpD,CAAM,CAAC,aAAaoD,EAAO,KAAKD,EAAwB,CAAA,CAAC,EAC3F,EAGFnD,EAASgB,GAAe,SAGnBhB,CACT,EClCMqD,GAAe,iBAUfC,GAAiB,CAACC,EAAajF,IACnCiF,EAAI,QAAQF,GAAeG,GAAU,CACnC,IAAIC,EAASnF,EAAM,IAAIkF,CAAK,EAE5B,OAAKC,IACHA,EAAShE,EAAO,EAChBnB,EAAM,IAAIkF,EAAOC,CAAM,GAGlBA,CACT,CAAC,EAEGC,GAAkB,CAACH,EAAajF,IAAiC,CACrE,IAAI0B,EAASuD,EAEb,OAAAjF,EAAM,QAAQ,CAACmF,EAAQD,IAAU,CAC/BxD,EAASA,EAAO,WAAWyD,EAAQD,CAAK,CAC1C,CAAC,EAEMxD,CACT,EAEa2D,GAAiB,CAC5BJ,EACAK,IACW,CACX,MAAMtF,EAAQ,IAAI,IAElB,OAAOoF,GAAgBE,EAAUN,GAAeC,EAAKjF,CAAK,EAAE,QAAS,CAAA,EAAGA,CAAK,CAC/E,ECjBauF,GAAuB,CAClCzC,EACAF,EACAU,EACAN,EACA6B,IACwB,CACxB,MAAMhB,EAAeD,GAAgBhB,CAAO,EAE5C,MAAO,CAAC4C,EAASC,EAAUjE,IACzB6D,GAAeG,EAAUP,GACvBnC,EAAY,WAAWmC,EAAK,CAC1B,KAAMN,GAAYc,EAAU7C,EAASI,EAAU6B,CAAsB,EACrE,KAAM,CAKJ,MAAOrD,CACT,EACA,aAAc,CACZ,GAAGqC,EACH,GAAKjB,EAAQ,gBAAkB,GAC3B,CAAC8C,EAA8BnE,GAAaC,CAAK,CAAC,CAAC,EACnD,CAAA,EACJ,GAAG4C,GAAsB5C,EAAOoB,EAAQ,UAAU,EAClD,GAAIU,GAAqB,CAAA,EACzB,GAAIV,EAAQ,cAAgB,CAAA,CAC9B,EACA,GAAI,WAAYA,EACZ,CACE,OAAQA,EAAQ,OAChB,aAAc,EAChB,EACA,CAAE,MAAOA,EAAQ,OAAS,MAAO,CACvC,CAAC,CACH,CACJ,ECvDM+C,EAAyB,cAElBC,GAAwB7F,GAAuB,CAC1D,MAAM8F,EAAW9F,EAAG,SAAS,MAAM,MAEnCA,EAAG,SAAS,MAAM,MAAQ,IAAI+F,IAAS,CACrC,KAAM,CAACC,EAAQC,CAAG,EAAIF,EAChBG,EAAQF,EAAOC,CAAG,EAElBE,EAAUD,EAAM,MAAQ,GACxBvE,EAASwE,EAAQ,MAAMP,CAAsB,EAEnD,GAAI,CAACjE,EACH,OAAOmE,EAAS,GAAGC,CAAI,EAIzBG,EAAM,KAAOC,EAAQ,QAAQP,EAAwB,EAAE,EAAE,KAAK,EAE9D,MAAMQ,EAAQzE,EAAO,CAAC,EAEtB,OAAAuE,EAAM,MAAQ,IAAIE,CAAK,GAChBN,EAAS,GAAGC,CAAI,CACzB,CACF,ECzBMM,GAAmB,wCAYZC,GAAmB,CAC9BtG,EACA,CAAE,WAAAuG,EAAa,EAAK,EAAiC,CAAA,IAC5C,CACT,MAAMT,EAAW9F,EAAG,SAAS,MAAM,MAEnCA,EAAG,SAAS,MAAM,MAAQ,IAAI+F,IAAS,CACrC,IAAIpE,EAASmE,EAAS,GAAGC,CAAI,EAE7B,GAAI,CAACpE,EAAO,WAAW,MAAM,EAC3B,OAAOA,EAGT,KAAM,CAACqE,EAAQC,EAAKpD,CAAO,EAAIkD,EACzBG,EAAQF,EAAOC,CAAG,EAGlB1E,EAAO2E,EAAM,KAAOlG,EAAG,MAAM,YAAYkG,EAAM,IAAI,EAAE,KAAK,EAAI,GAE9DhD,EAAO5B,EAAgBC,CAAI,EAC3BiF,EAAgB,GAAG3D,EAAQ,UAAU,GAAGK,CAAI,GAElD,GAAI,CAACqD,EAcH,OAAA5E,EAASA,EAAO,QAAQ,cAAe,QAAQ,EAC/CA,EAAS,eAAe6E,CAAa,IAAI7E,EAAO,MAAM,CAAa,CAAC,GAC7DA,EAET,IAAI8E,EAAS,GAIb,OAAA9E,EAASA,EAAO,QACd0E,GACA,CAACrE,EAAG0E,EAAgBC,EAAeC,KACjCH,EAASE,EAAM,KAAK,EAEb,QAAQD,EAAO,KAAA,CAAM,GAAGE,EAAM,QAAS,CAAA,IAElD,EAKO,eAAeJ,CAAa,wCAAwCtD,CAAI,YAAYuD,CAAM,KAAK9E,CAAM,QAC9G,CACF,ECtEakF,GAA0B,CACrCrE,EACA,CACE,YAAAsE,EAAc,GACd,eAAAC,EAAiB,GACjB,eAAAC,EAAiB,UACjB,eAAAC,EAAiB,GACjB,aAAAC,EACA,mBAAAC,EACA,cAAAC,EACA,kBAAAC,EACA,sBAAAC,EACA,WAAAC,EACA,SAAAC,CACF,IACoB,CACpB,MAAMC,EAAoB,CACxB,WAAWC,EAAc,+CAAgD,WAAW,CAAC,IACrF,WAAWA,EAAc,GAAGzG,CAAW,oBAAqB,WAAW,CAAC,GAC1E,EAEM0G,EAAqB,GACrBC,EAAmB,CAErBd,EAAAA,IAAgB,WAClBW,EAAQ,KACN,WAAWC,EAAc,uDAAwD,WAAW,CAAC,GAC/F,GAGEX,GAAkBM,IACpBI,EAAQ,KACN,WAAWC,EAAc,6DAA8D,WAAW,CAAC,GACrG,EAGER,GACFO,EAAQ,KACN,WAAWC,EAAc,wDAAyD,WAAW,CAAC,GAChG,EAGEP,GACFM,EAAQ,KACN,WAAWC,EAAc,+DAAgE,WAAW,CAAC,GACvG,EAGEN,GACFK,EAAQ,KACN,WAAWC,EAAc,yDAA0D,WAAW,CAAC,GACjG,EAGEL,GACFI,EAAQ,KACN,WAAWC,EAAc,6DAA8D,WAAW,CAAC,GACrG,EAGEJ,GACFG,EAAQ,KACN,WAAWC,EAAc,kEAAmE,WAAW,CAAC,GAC1G,EAGEH,GACFE,EAAQ,KACN,WAAWC,EAAc,qDAAsD,WAAW,CAAC,GAC7F,EAGEV,IAAmB,YACrBS,EAAQ,KACN,WAAWC,EAAc,0DAA2D,WAAW,CAAC,IAChG,wCAAwCA,EAAc,sCAAuC,WAAW,CAAC,GAC3G,EACAE,EAAO,KAAK,uBAAuB,GAGjCX,GACFQ,EAAQ,KACN,WAAWC,EAAc,2DAA4D,WAAW,CAAC,GACnG,EAGEF,IACFC,EAAQ,KACN,oCAAoCC,EAAc,kCAAmC,WAAW,CAAC,GACnG,EACAD,EAAQ,KACN,WAAWC,EAAc,+CAAgD,WAAW,CAAC,GACvF,EACAC,EAAS,KAAK,sBAAsB,GAGtC,IAAIjH,EAAO+G,EAAQ,KAAK;AAAA,CAAI,EAE5B,OAAIG,EAAO,QAAUD,EAAS,UAC5BjH,GAAQ;AAAA;AAAA,EAIJiH,EAAS,SACXjH,GAAQ;AAAA,MAERiH,EAAS,KAAK;AAAA,KAAQ,CAAC;AAAA;AAAA,GAKrBC,EAAO,SACTlH,GAAQ;AAAA,MAERkH,EAAO,KAAK;AAAA,KAAQ,CAAC;AAAA;AAAA,GAKvBlH,GAAQ;AAAA,GAKH8B,EAAI,UAAU,kBAAmB9B,CAAI,CAC9C,ECxGamH,GAAc,CAACC,EAA+B,CAAA,IACjDtF,GAAQ,CAGd,KAAM,CAAE,KAAA9B,CAAK,EAAI8B,EAAI,QAAQ,SACvBK,EAAU,CACd,GAAIe,EAAclD,CAAI,EAAIA,EAAO,CAAC,EAClC,GAAGoH,CACL,EAEAjF,EAAQ,WAAaL,EAAI,IAAI,QAAU,QAAU,OACjDK,EAAQ,aAAe,GACvBA,EAAQ,cAAgB,GACxBA,EAAQ,iBAAmB,UAC3BA,EAAQ,iBAAmB,GAGzBA,EAAQ,UACR,CAACkF,EAAkB,2BAA4B,WAAW,IAE1D7G,EAAO,MACL,GAAG6D,EAAO,KAAK,UAAU,CAAC,oBAAoBA,EAAO,QAAQ,0BAA0B,CAAC,+CAC1F,EACAlC,EAAQ,SAAW,IAMrB,IAAIC,EAAa,GAEjB,MAAO,CACL,KAAM,yBAEN,uBAAyBkF,GAAS,CAIhC,GAAIA,EAAK,OAAS,GAAO,CACvB,MAAMC,EAAOrE,EAAcoE,EAAK,IAAI,EAAIA,EAAK,KAAO,CAAE,MAAO,EAAK,EAC9DC,EAAK,QACPD,EAAK,OAAS,GACdA,EAAK,KAAK,MAAQ,IAEpBlF,EAAamF,EAAK,OAAS,EAC7B,MACEnF,EAAa,EAEjB,EAEA,gBAAiB,MAAO9C,GAAO,CAC7B,KAAM,CAAE,WAAAuG,EAAY,YAAAO,EAAa,eAAAE,EAAgB,eAAAC,CAAe,EAC9DpE,EAEIiC,EAAyB/E,EAA6BC,CAAE,EACxD,CAAE,YAAA+C,EAAa,SAAAE,EAAU,kBAAAM,CAAkB,EAC/C,MAAMhB,GAAuBC,EAAKK,EAASC,CAAU,EAEvD9C,EAAG,QAAQ,UAAYwF,GACrBzC,EACAF,EACAU,EACAN,EACA6B,CACF,EAEA9E,EAAG,IAAI6F,EAAoB,EAC3B7F,EAAG,IAAiCsG,GAAkB,CAAE,WAAAC,CAAW,CAAC,EAChEA,IACFvG,EAAG,IAAkCkI,EAAmB,CACtD,YAAApB,EACA,mBAAmBvF,EAAM,CACvB,OAAOsB,EAAQ,UAAY7B,EAAY,KAAKO,CAAI,EAC5C,GACA,MACN,CACF,CAAC,EACDvB,EAAG,IAAqCmI,EAAsB,CAC5D,eAAAnB,CACF,CAAC,EACDhH,EAAG,IAAqCoI,EAAsB,CAC5D,eAAAnB,CACF,CAAC,EAEL,EAEA,iBAAkB,IAAMJ,GAAwBrE,EAAKK,CAAO,CAC9D,CACF"}