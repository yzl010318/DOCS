import{Logger as P,getModulePath as c,isModuleAvailable as N}from"@vuepress/helper";import{resolveWhitespacePosition as A,lineNumbers as C,collapsedLines as H,codeBlockTitle as W}from"@vuepress/highlighter-helper";import{isPlainObject as w}from"vuepress/shared";import{colors as v}from"vuepress/utils";import{customAlphabet as E}from"nanoid";import{createRequire as x}from"node:module";import{createHighlighter as M,isSpecialLang as S}from"shiki";import{createSyncFn as F}from"synckit";import{transformerNotationDiff as j,transformerNotationFocus as O,transformerNotationHighlight as B,transformerNotationErrorLevel as D,transformerNotationWordHighlight as R,transformerMetaWordHighlight as _,transformerRenderWhitespace as q,transformerCompactLineOptions as G}from"@shikijs/transformers";const I=s=>{const e={},i=s.render.bind(s);return s.render=(t,o={})=>(e.path=o.filePathRelative,i(t,o)),()=>e.path||"dynamic pages"},U=/\[\\!code/g,z={name:"vuepress:add-class",pre(s){this.addClassToHast(s,"vp-code")}},J={name:"vuepress:cleanup",pre(s){delete s.properties.tabindex}},K={name:"vuepress:remove-escape",postprocess(s){return s.replace(U,"[!code")}},Q={name:"vuepress:empty-line",code(s){s.children.forEach(e=>{e.type==="element"&&e.tagName==="span"&&Array.isArray(e.properties.class)&&e.properties.class.includes("line")&&e.children.length===0&&e.children.push({type:"element",tagName:"wbr",properties:{},children:[]})})}},V={name:"vuepress:v-pre",pre(s){s.properties["v-pre"]=""}},X=/-vue$/,Y=/\btwoslash\b/,L="@vuepress/plugin-shiki",y=new P(L),Z=E("abcdefghijklmnopqrstuvwxyz",10),$=s=>s.match(/^([^ :[{]+)/)?.[1]?.replace(X,"").toLowerCase()??"",ee=s=>{const e=s.replace(/^(?:\[.*?\])?.*?([\d,-]+).*/,"$1").trim(),i=[];return e?(e.split(",").map(t=>t.split("-").map(o=>parseInt(o,10))).forEach(([t,o])=>{t&&o?i.push(...Array.from({length:o-t+1},(r,a)=>t+a)):i.push(t)}),i.map(t=>({line:t,classes:["highlighted"]}))):[]},se=x(import.meta.url),te=F(se.resolve("@vuepress/plugin-shiki/resolveLang")),re=async(s,{langs:e=[],langAlias:i={},defaultLang:t,shikiSetup:o,...r}={},a=!0)=>{const l=await M({langs:[...e,...Object.values(i)],langAlias:i,themes:"themes"in r?Object.values(r.themes):[r.theme??"nord"]}),p=h=>{if(S(h))return!0;if(!l.getLoadedLanguages().includes(h)){const n=te(h);if(!n.length)return!1;l.loadLanguageSync(n)}return!0},d=l.getLanguage;l.getLanguage=h=>{const n=typeof h=="string"?h:h.name;return p($(n)),d.call(l,h)};const m=[];if(a&&m.push(V),r.twoslash){const{createTwoslashTransformer:h,createFileSystemTypesCache:n}=await import("@vuepress/shiki-twoslash"),{typesCache:u,...g}=w(r.twoslash)?r.twoslash:{};m.push(await h({...g,typesCache:u===!0||typeof u>"u"?n({dir:s.dir.cache("markdown/twoslash")}):u}))}return await o?.(l),{highlighter:l,loadLang:p,extraTransformers:m}},ie=s=>{const e=[];return s.notationDiff&&e.push(j()),s.notationFocus&&e.push(O({classActiveLine:"has-focus",classActivePre:"has-focused-lines"})),s.notationHighlight&&e.push(B()),s.notationErrorLevel&&e.push(D()),s.notationWordHighlight&&(e.push(R()),e.push(_())),e.push(z,J,K,Q),e},oe=(s,e=!1)=>{const i=A(s,e);return i===!1?[]:[q({position:i})]},b=new Set,ne=(s,{defaultLang:e,logLevel:i},t,o)=>{let r=$(s);return r&&!t(r)&&(i!=="silent"&&!b.has(r)&&(y.warn(`Missing ${v.cyan(s)} highlighter, ${e?`use ${v.cyan(e)} to highlight instead.`:"skip highlighting"}`),b.add(r)),i==="debug"&&y.info(`Unknown language ${v.cyan(r)} found in ${v.cyan(o())}`),r=e||"plain"),r},ae=/\{\{[^]*?\}\}/g,le=(s,e)=>s.replace(ae,i=>{let t=e.get(i);return t||(t=Z(),e.set(i,t)),t}),he=(s,e)=>{let i=s;return e.forEach((t,o)=>{i=i.replaceAll(t,o)}),i},pe=(s,e)=>{const i=new Map;return he(e(le(s,i).trimEnd()),i)},ce=(s,e,i,t,o)=>{const r=ie(e);return(a,l,p)=>pe(a,d=>s.codeToHtml(d,{lang:ne(l,e,t,o),meta:{__raw:p},transformers:[...r,...e.highlightLines??!0?[G(ee(p))]:[],...oe(p,e.whitespace),...i??[],...e.transformers??[]],..."themes"in e?{themes:e.themes,defaultColor:!1}:{theme:e.theme??"nord"}}))},k=/{([\d,-]+)}/,ue=s=>{const e=s.renderer.rules.fence;s.renderer.rules.fence=(...i)=>{const[t,o]=i,r=t[o],a=r.info||"",l=a.match(k);if(!l)return e(...i);r.info=a.replace(k,"").trim();const p=l[1];return r.info+=` ${p}`,e(...i)}},me=/<pre([\s\S]*?)style="([^"]*)"([^>]*)>/,ge=(s,{preWrapper:e=!0}={})=>{const i=s.renderer.rules.fence;s.renderer.rules.fence=(...t)=>{let o=i(...t);if(!o.startsWith("<pre"))return o;const[r,a,l]=t,p=r[a],d=p.info?s.utils.unescapeAll(p.info).trim():"",m=$(d),h=`${l.langPrefix}${m}`;if(!e)return o=o.replace(/<code[^]*?>/,"<code>"),o=`<pre class="${h}"${o.slice(4)}`,o;let n="";return o=o.replace(me,(u,g,f,T)=>(n=f.trim(),`<pre ${g.trim()}${T.trimEnd()}>`)),`<div class="${h}" data-highlighter="shiki" data-ext="${m}" style="${n}">${o}</div>`}},de=(s,{lineNumbers:e=!0,highlightLines:i=!0,collapsedLines:t="disable",codeBlockTitle:o=!0,notationDiff:r,notationErrorLevel:a,notationFocus:l,notationHighlight:p,notationWordHighlight:d,whitespace:m,twoslash:h})=>{const n=[`import "${c("@vuepress/highlighter-helper/styles/base.css",import.meta)}"`,`import "${c(`${L}/styles/shiki.css`,import.meta)}"`],u=[],g=[];e!=="disable"&&n.push(`import "${c("@vuepress/highlighter-helper/styles/line-numbers.css",import.meta)}"`),(i||p)&&n.push(`import "${c("@vuepress/highlighter-helper/styles/notation-highlight.css",import.meta)}"`),r&&n.push(`import "${c("@vuepress/highlighter-helper/styles/notation-diff.css",import.meta)}"`),a&&n.push(`import "${c("@vuepress/highlighter-helper/styles/notation-error-level.css",import.meta)}"`),l&&n.push(`import "${c("@vuepress/highlighter-helper/styles/notation-focus.css",import.meta)}"`),p&&n.push(`import "${c("@vuepress/highlighter-helper/styles/notation-highlight.css",import.meta)}"`),d&&n.push(`import "${c("@vuepress/highlighter-helper/styles/notation-word-highlight.css",import.meta)}"`),m&&n.push(`import "${c("@vuepress/highlighter-helper/styles/whitespace.css",import.meta)}"`),t!=="disable"&&(n.push(`import "${c("@vuepress/highlighter-helper/styles/collapsed-lines.css",import.meta)}"`,`import { setupCollapsedLines } from "${c("@vuepress/highlighter-helper/client",import.meta)}"`),g.push("setupCollapsedLines()")),o&&n.push(`import "${c("@vuepress/highlighter-helper/styles/code-block-title.css",import.meta)}"`),h&&(n.push(`import { enhanceTwoslash } from "${c("@vuepress/shiki-twoslash/client",import.meta)}"`),n.push(`import "${c("@vuepress/shiki-twoslash/styles/twoslash.css",import.meta)}"`),u.push("enhanceTwoslash(app)"));let f=n.join(`
`);return(g.length||u.length)&&(f+=`
export default {
`,u.length&&(f+=`  enhance({ app }) {
    ${u.join(`
    `)}
  },
`),g.length&&(f+=`  setup() {
    ${g.join(`
    `)}
  },
`),f+=`}
`),s.writeTemp("shiki/config.js",f)},fe=(s={})=>e=>{const{code:i}=e.options.markdown,t={...w(i)?i:{},...s};t.logLevel??=e.env.isDebug?"debug":"warn",t.preWrapper??=!0,t.lineNumbers??=!0,t.collapsedLines??="disable",t.codeBlockTitle??=!0,t.twoslash&&!N("@vuepress/shiki-twoslash",import.meta)&&(y.error(`${v.cyan("twoslash")} is enabled, but ${v.magenta("@vuepress/shiki-twoslash")} is not installed, please install it manually`),t.twoslash=!1);let o=!0;return{name:"@vuepress/plugin-shiki",extendsMarkdownOptions:r=>{if(r.vPre!==!1){const a=w(r.vPre)?r.vPre:{block:!0};a.block&&(r.vPre??={},r.vPre.block=!1),o=a.block??!0}else o=!1},extendsMarkdown:async r=>{const{preWrapper:a,lineNumbers:l,collapsedLines:p,codeBlockTitle:d}=t,m=I(r),{highlighter:h,loadLang:n,extraTransformers:u}=await re(e,t,o);r.options.highlight=ce(h,t,u,n,m),r.use(ue),r.use(ge,{preWrapper:a}),a&&(r.use(C,{lineNumbers:l,resolveLineNumbers(g){return t.twoslash&&Y.test(g)?!1:void 0}}),r.use(H,{collapsedLines:p}),r.use(W,{codeBlockTitle:d}))},clientConfigFile:()=>de(e,t)}};export{fe as shikiPlugin};
//# sourceMappingURL=index.js.map
